# 機能仕様: 読み辞書生成のXMLファイル対応

**Feature Branch**: `006-xml-dict-support`
**Created**: 2026-02-18
**Status**: Draft
**Input**: GitHub Issue #3 - generate_reading_dict.py does not support XML files

## Clarifications

### Session 2026-02-18

- Q: XMLからのテキスト抽出時、ページ分割をどう扱うか？ → A: ContentItemをチャプター単位でグループ化してから用語抽出する

## ユーザーシナリオ & テスト *(必須)*

### ユーザーストーリー 1 - XMLファイルから読み辞書を生成 (Priority: P1)

ユーザーは `book2.xml` 形式のXMLファイルを入力として指定し、技術用語の読み辞書（`readings.json`）を自動生成できる。現在はMarkdownファイルのみ対応しているが、XMLパイプライン（`xml2_pipeline.py`）で使用するXMLファイルにも対応する必要がある。

**優先度の理由**: XMLパイプラインの利用者が読み辞書を生成できないという本質的な問題を解決するコア機能である。

**独立テスト**: `make gen-dict INPUT=sample/book2.xml` を実行し、`data/{hash}/readings.json` が正しく生成されることを確認する。

**受入シナリオ**:

1. **Given** XMLファイル（`book2.xml`形式）が存在する, **When** `make gen-dict INPUT=sample/book2.xml` を実行する, **Then** XMLの内容が解析され `readings.json` が生成される
2. **Given** XMLファイルに技術用語が含まれている, **When** 辞書生成を実行する, **Then** 抽出された用語の読みがLLMによって生成され辞書に保存される
3. **Given** 既存の `readings.json` がある状態で `--merge` を指定する, **When** XMLファイルで辞書生成を実行する, **Then** 既存辞書と新規エントリが統合される

---

### ユーザーストーリー 2 - Markdownファイルの既存動作を維持 (Priority: P1)

既存のMarkdownファイル入力による辞書生成が、XML対応追加後も正しく動作し続ける。

**優先度の理由**: 既存機能のリグレッション防止はXML対応と同等に重要である。

**独立テスト**: `make gen-dict INPUT=sample/test.md` を実行し、従来通り辞書が生成されることを確認する。

**受入シナリオ**:

1. **Given** Markdownファイルが存在する, **When** 辞書生成を実行する, **Then** 従来と同一の結果が得られる

---

### エッジケース

- XMLファイルにテキストコンテンツが含まれない場合はどうなるか？ → 空の辞書が生成され、正常終了する
- 不正な形式のXMLファイルが指定された場合はどうなるか？ → エラーメッセージを表示して異常終了する
- `.xml` でも `book2.xml` 形式でないXMLが指定された場合はどうなるか？ → パーサーのエラーハンドリングに従い、適切なエラーを表示する
- 入力ファイルの拡張子が `.md` でも `.xml` でもない場合はどうなるか？ → エラーメッセージを表示して異常終了する
- XMLファイル内にチャプター区切りがないContentItemが存在する場合はどうなるか？ → チャプター番号なしのアイテムも含めて用語抽出対象とする

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは入力ファイルの拡張子（`.xml` / `.md`）に基づいて処理方法を自動判別しなければならない
- **FR-002**: XMLファイル入力時、システムは既存のXMLパーサーを使用してテキストコンテンツを抽出しなければならない
- **FR-003**: XMLから抽出されたContentItemはチャプター単位でグループ化し、チャプター毎のテキストから技術用語を識別しなければならない
- **FR-004**: 抽出された技術用語に対し、LLMを使って読みを生成しなければならない
- **FR-005**: 生成された読み辞書は既存のMarkdown入力時と同一の形式（`readings.json`）で、入力ファイルのコンテンツハッシュに基づくディレクトリ（`data/{hash}/readings.json`）に保存されなければならない
- **FR-006**: `--merge` オプションはXML入力でも既存辞書との統合が動作しなければならない
- **FR-007**: サポート外の拡張子の場合、システムは明確なエラーメッセージを表示して終了しなければならない

### 主要エンティティ

- **入力ファイル**: 読み辞書の生成元となるテキストファイル（Markdown または XML）
- **コンテンツアイテム**: XMLから抽出されたテキスト要素（段落、見出し、リスト項目など）。チャプター番号を持つ
- **チャプターグループ**: 同一チャプター番号を持つContentItemの集合。用語抽出の処理単位となる
- **読み辞書**: 技術用語とその読みの対応を格納するJSONファイル。`data/{hash}/readings.json` に保存される

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: XMLファイルを入力として読み辞書が正常に生成される
- **SC-002**: XML入力で生成された辞書の形式がMarkdown入力時と同一である
- **SC-003**: Markdownファイル入力の既存動作に変更がない（リグレッションなし）
- **SC-004**: 不正な入力ファイル（未対応拡張子、不正XML）に対して適切なエラーメッセージが表示される

## 前提条件

- `xml2_parser.py` の `parse_book2_xml()` 関数が正しく動作することを前提とする
- XMLファイルは `book2.xml` 形式（プロジェクト固有のXMLスキーマ）であることを前提とする
- LLM（Ollama）のエンドポイントが利用可能であることを前提とする
