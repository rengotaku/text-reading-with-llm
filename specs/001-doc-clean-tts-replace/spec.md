# Feature Specification: ドキュメントクリーン TTS代替置換機能

**Feature Branch**: `001-doc-clean-tts-replace`
**Created**: 2026-02-06
**Status**: Draft
**Input**: User description: "ドキュメントクリーンの改良。口頭で言われても分からないものは代替情報に置換するようにしたい"

## Clarifications

### Session 2026-02-06

- Q: 括弧付き用語「トイル（Toil）」の読み上げ方法 → A: 日本語部分のみ読む（「トイル」）。括弧内の英語表記は除去する。
- Q: 読点挿入ロジックの修正をスコープに含めるか → A: 本機能のスコープに含める。「ではありません」等の助詞+動詞の途中に読点を挿入しない。
- Q: コロン（：）の読み上げ処理 → A: コロンを「は、」に変換する。「効果測定：トイル削減施策」→「効果測定は、トイル削減施策」
- Q: コロン変換の対象範囲 → A: 全角・半角コロン両方を変換。ただし数字:数字パターン（時刻・比率）は除外。
- Q: 裸のURLの読み上げ方法 → A: 完全に削除（何も読まない）。Markdownリンクはリンクテキストのみ残す。
- Q: 鉤括弧「」の処理方法 → A: 開き鉤括弧「→読点（、）、閉じ鉤括弧」→読点（、）に変換。引用部分を明確に区切る。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - URL の除去・簡略化 (Priority: P1)

ユーザーがMarkdownドキュメントをTTS用にクリーニングする際、URLが適切に処理され（リンクテキストのみ残すか、完全削除）、音声で聞いても理解できる形式になる。

**Why this priority**: URLは最も頻繁に出現し、読み上げると「エイチティーティーピーエス、コロン、スラッシュ、スラッシュ...」と非常に長く意味不明になる。sample/book.mdでも30件以上のURLが含まれている。

**Independent Test**: URLを含むテキストを処理し、Markdownリンクはリンクテキストのみ残り、裸のURLは完全に削除されることを確認する。

**Acceptance Scenarios**:

1. **Given** Markdownリンク `[SRE NEXT](https://sre-next.dev/)` を含むテキスト, **When** クリーニング処理を実行, **Then** URLは除去され「SRE NEXT」のみが残る
2. **Given** 裸のURL `https://example.com/path/to/page` を含むテキスト, **When** クリーニング処理を実行, **Then** URLは完全に削除される（何も残らない）
3. **Given** URLのみがリンクテキストのケース `[https://example.com](https://example.com)`, **When** クリーニング処理を実行, **Then** 完全に削除される（何も残らない）

---

### User Story 2 - 図表参照の適切な読み上げ (Priority: P2)

ドキュメント内の図表参照（「図2.1」「表1.2」など）が、聞いて理解しやすい形式で読み上げられる。

**Why this priority**: 技術ドキュメントには図表参照が多く含まれ、数字の読み方が不自然だと理解の妨げになる。

**Independent Test**: 「図2.1」「表1.2」などの参照を含むテキストを処理し、自然な読み上げ形式（「ずにてんいち」「ひょういちてんに」など）に変換されることを確認する。

**Acceptance Scenarios**:

1. **Given** 「図2.1に示します」というテキスト, **When** クリーニング処理を実行, **Then** 「ずにてんいちにしめします」と読み上げられる形式になる
2. **Given** 「表1.2 SREのスキルセット」というテキスト, **When** クリーニング処理を実行, **Then** 「ひょういちてんに SREのスキルセット」と読み上げられる形式になる

---

### User Story 3 - 脚注・注釈番号の処理 (Priority: P3)

ドキュメント内の脚注参照（「注1.1」「注2.3」など）が適切に処理され、聞き手が内容を追跡しやすくなる。

**Why this priority**: 脚注は補足情報であり、本文の流れを妨げないよう処理する必要がある。

**Independent Test**: 脚注参照を含むテキストを処理し、適切な形式で読み上げられることを確認する。

**Acceptance Scenarios**:

1. **Given** 「ローリングアップデート注1.6、Blue-Greenデプロイメント注1.7」というテキスト, **When** クリーニング処理を実行, **Then** 注釈番号が自然に読み上げられる形式になる（例：「ローリングアップデート、ちゅういちてんろく」）
2. **Given** 脚注見出し「### 注1.1」, **When** クリーニング処理を実行, **Then** 「ちゅう いちてんいち」と読み上げられる形式になる

---

### User Story 4 - ISBN・書籍情報の簡略化 (Priority: P3)

ISBN番号や長い書籍メタ情報が、聞いて意味のある形式に簡略化される。

**Why this priority**: ISBNは13桁の数字列であり、読み上げても意味がない。

**Independent Test**: ISBN番号を含むテキストを処理し、適切に簡略化されることを確認する。

**Acceptance Scenarios**:

1. **Given** 「ISBN978-4-297-15072-3」を含むテキスト, **When** クリーニング処理を実行, **Then** 「ISBN省略」または完全に削除される

---

### User Story 5 - 括弧付き用語の重複読み防止 (Priority: P2)

「トイル（Toil）」「SRE（Site Reliability Engineering）」のような日本語と英語の対訳括弧表記が、重複せず日本語部分のみ読み上げられる。

**Why this priority**: 技術ドキュメントでは用語の英語表記が括弧内に頻繁に記載され、そのまま読み上げると冗長で不自然になる。

**Independent Test**: 括弧付き用語を含むテキストを処理し、日本語部分のみが読み上げられることを確認する。

**Acceptance Scenarios**:

1. **Given** 「トイル（Toil）の削減」というテキスト, **When** クリーニング処理を実行, **Then** 「トイルの削減」と読み上げられる（括弧と英語表記は除去）
2. **Given** 「SRE（Site Reliability Engineering）に関する」というテキスト, **When** クリーニング処理を実行, **Then** 「SREに関する」と読み上げられる（括弧と英語表記は除去）
3. **Given** 「可観測性（Observability）」というテキスト, **When** クリーニング処理を実行, **Then** 「可観測性」と読み上げられる

---

### User Story 6 - 不適切な読点挿入の修正 (Priority: P2)

「ではありません」「ではない」等の助詞+動詞の組み合わせ途中に読点が挿入されず、自然な読み上げが維持される。

**Why this priority**: 現在の読点挿入ロジック（「は」の後に読点挿入）が過剰に適用され、文法的に不自然な位置に読点が入る問題がある。

**Independent Test**: 「ではありません」等のパターンを含むテキストを処理し、不適切な位置に読点が挿入されないことを確認する。

**Acceptance Scenarios**:

1. **Given** 「終わりではありません」というテキスト, **When** クリーニング処理を実行, **Then** 「オワリではありません」と読み上げられる（「では」の後に読点なし）
2. **Given** 「問題ではない」というテキスト, **When** クリーニング処理を実行, **Then** 「モンダイではない」と読み上げられる（「では」の後に読点なし）
3. **Given** 「これは重要ではありますが」というテキスト, **When** クリーニング処理を実行, **Then** 「これは、ジュウヨウではありますが」と読み上げられる（「これは」の後は読点OK、「では」の後は読点なし）

---

### User Story 7 - コロン記号の自然な読み上げ変換 (Priority: P2)

見出しと説明を区切るコロン（：）が「は、」に変換され、自然な読み上げになる。

**Why this priority**: コロンは視覚的な区切りとして使われるが、そのまま無視すると文が繋がって聞き取りにくくなる。

**Independent Test**: コロンを含むテキストを処理し、「は、」に変換されることを確認する。

**Acceptance Scenarios**:

1. **Given** 「効果測定：トイル削減施策の効果を定期的に測定する」というテキスト, **When** クリーニング処理を実行, **Then** 「効果測定は、トイル削減施策の効果を定期的に測定する」と読み上げられる
2. **Given** 「目的：システムの信頼性向上」というテキスト, **When** クリーニング処理を実行, **Then** 「目的は、システムの信頼性向上」と読み上げられる
3. **Given** 「注意：この操作は取り消せません」というテキスト, **When** クリーニング処理を実行, **Then** 「注意は、この操作は取り消せません」と読み上げられる

---

### User Story 8 - 鉤括弧の読点変換 (Priority: P2)

鉤括弧「」で囲まれた固有名詞や引用部分が、前後の文と明確に区切られて読み上げられる。

**Why this priority**: 鉤括弧は視覚的な引用マーカーだが、TTSでは無視されると前後の文と繋がって聞き取りにくくなる。

**Independent Test**: 鉤括弧を含むテキストを処理し、鉤括弧が読点に変換されることを確認する。

**Acceptance Scenarios**:

1. **Given** 「テックカンファレンス「SRE NEXT」を立ち上げ」というテキスト, **When** クリーニング処理を実行, **Then** 「テックカンファレンス、SRE NEXT、を立ち上げ」と読み上げられる
2. **Given** 「本書は「入門書」です」というテキスト, **When** クリーニング処理を実行, **Then** 「本書は、入門書、です」と読み上げられる
3. **Given** 「「はじめに」を参照」というテキスト, **When** クリーニング処理を実行, **Then** 「、はじめに、を参照」と読み上げられる

---

### Edge Cases

- 複数のURL/参照が連続して出現する場合の処理
- リンクテキストが非常に長い場合（50文字以上など）の処理
- 入れ子になったMarkdownリンクの処理
- 日本語と英語が混在するリンクテキストの処理
- 既にクリーニング済みのテキストを再処理した場合の冪等性
- 括弧内に日本語説明がある場合（例：「API（アプリケーションプログラミングインターフェース）」）の処理
- 「ではありません」「ではない」以外の助詞+動詞パターン（「にはならない」「とはいえない」等）
- URL内のコロン（https:）は変換対象外とする
- 時刻表記のコロン（10:00）は変換対象外とする
- 比率表記のコロン（1:3）は変換対象外とする

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、Markdownリンク `[テキスト](URL)` からURLを除去し、リンクテキストのみを残すこと
- **FR-002**: システムは、裸のURL（`https://...`）を検出し、完全に削除すること（何も残さない）
- **FR-003**: システムは、リンクテキストがURL自体の場合（`[https://example.com](https://example.com)`）を検出し、完全に削除すること
- **FR-004**: システムは、図番号（図1.1、図2.1等）を日本語として自然に読める形式に変換すること
- **FR-005**: システムは、表番号（表1.1、表2.A等）を日本語として自然に読める形式に変換すること
- **FR-006**: システムは、脚注番号（注1.1等）を日本語として自然に読める形式に変換すること
- **FR-007**: システムは、ISBN番号を検出し、「ISBN省略」に置換または削除すること
- **FR-008**: システムは、既存のtext_cleaner.pyの処理パイプラインに統合されること
- **FR-009**: システムは、処理の冪等性を保証すること（同じ入力に対して常に同じ出力）
- **FR-010**: システムは、「用語（英語表記）」形式の括弧付き表記から括弧と英語表記を除去し、日本語用語のみを残すこと
- **FR-011**: システムは、「ではありません」「ではない」等の助詞+動詞パターンの途中に読点を挿入しないこと
- **FR-012**: システムは、コロン（全角：・半角:）を「は、」に変換すること。ただし以下は除外：URL内、数字:数字パターン（時刻10:00、比率1:3等）
- **FR-013**: システムは、鉤括弧「」を読点（、）に変換すること。開き括弧「→「、」、閉じ括弧」→「、」

### Key Entities

- **置換ルール**: 検出パターン（正規表現）、置換テキスト、優先度を持つルール定義
- **代替テキストタイプ**: URL省略、図参照、表参照、脚注参照、ISBN省略、括弧内英語表記、コロン変換などのカテゴリ
- **読点挿入除外パターン**: 読点を挿入してはいけない助詞+動詞の組み合わせパターン

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: sample/book.mdのURL（30件以上）がすべて適切に処理され、読み上げ時に「エイチティーティーピー」等の文字列が出現しないこと
- **SC-002**: 図表参照（図X.Y、表X.Y形式）が100%自然な日本語読みに変換されること
- **SC-003**: 脚注参照（注X.Y形式）が100%自然な日本語読みに変換されること
- **SC-004**: ISBN番号が100%簡略化または削除されること
- **SC-005**: 既存のTTS出力品質を維持しつつ、新規ルールが追加されること
- **SC-006**: 処理時間が既存のクリーニング処理から10%以上増加しないこと
- **SC-007**: 括弧付き用語（例：「トイル（Toil）」）が重複読みされず、日本語部分のみが読み上げられること
- **SC-008**: 「ではありません」「ではない」等のパターンで不適切な読点挿入が発生しないこと
- **SC-009**: 見出し区切りのコロンが「は、」に変換され、自然な読み上げになること
- **SC-010**: 鉤括弧「」が読点に変換され、引用部分が明確に区切られること

## Assumptions

- 対象はMarkdown形式のドキュメントのみ
- 日本語ドキュメントが主な対象（英語ドキュメントへの対応は将来検討）
- 既存のtext_cleaner.pyのアーキテクチャを大きく変更せずに拡張可能
- 図表番号は「図X.Y」「表X.Y」形式が標準（他の形式は将来検討）
- 脚注は「注X.Y」形式が標準
- 括弧付き用語の括弧内は英語表記が主（日本語説明の場合は保持を検討）
- 読点挿入除外パターンは「では」「には」「とは」等の助詞+助詞の組み合わせが対象
- コロン変換はURL処理後に適用（URL内のコロンは影響を受けない）

## Scope

### In Scope

- URL（Markdownリンク、裸のURL）の代替置換
- 図表参照番号の読み上げ最適化
- 脚注番号の読み上げ最適化
- ISBN番号の簡略化
- 括弧付き用語（英語表記）の除去
- 不適切な読点挿入の修正（punctuation_normalizer.py）
- コロン記号の「は、」への変換
- 鉤括弧「」の読点への変換
- 既存text_cleaner.pyへの統合

### Out of Scope

- HTMLタグの処理（既に対応済み）
- 画像の代替テキスト生成
- PDFからの変換処理
- 英語ドキュメント向けの最適化
- ユーザーによるカスタムルール定義機能
