# 機能仕様書: TTS前処理パターン置換

**Feature Branch**: `009-tts-pattern-replace`
**Created**: 2026-02-22
**Status**: Draft
**Input**: Issue #13 - TTS: URL・ISBN・章番号をTTS前処理で適切に置換する

## 背景と問題

`extract_technical_terms()` のフィルタ追加（#10）により辞書登録からは除外されたが、TTS読み上げ時には以下のパターンがそのまま渡され、不自然な読み上げが発生している。

**発生している問題**:
- `www.quora.com` → 「ダブリューダブリューダブリュー ドット クオーラ ドット コム」
- `ISBN978-4-7981-8771-6` → 数字とハイフンが逐一読まれる
- `No.21` → 「エヌオーにじゅういち」（「ナンバーにじゅういち」が自然）

**制約**: 単純削除は不可（読み上げが歯抜けになる）

## Clarifications

### Session 2026-02-22

- Q: 「No.」が章番号以外の文脈（製品番号、順位など）で使われた場合の動作は？ → A: 「No.」は文脈に関係なく「ナンバー」に置換する（章番号専用変換ではない）

## User Scenarios & Testing

### User Story 1 - URL含有テキストの自然な読み上げ (Priority: P1)

ユーザーがURLを含むテキストを音声で聞く際、URLが自然な代替テキストに置換され、文脈を損なわずに聞き取れる。

**Why this priority**: URLは技術文書で最も頻出するパターンであり、TTSで最も不自然な読み上げを引き起こす。

**Independent Test**: URLを含むテキストをTTS処理し、出力に「ダブリュー」「ドット」「コム」などのURL構成要素が含まれないことを確認。

**Acceptance Scenarios**:

1. **Given** テキスト「詳細は www.example.com を参照してください」, **When** TTS前処理を実行, **Then** 「詳細は ウェブサイト を参照してください」に置換される
2. **Given** テキスト「[公式サイト](https://example.com)をご覧ください」, **When** TTS前処理を実行, **Then** 「公式サイトをご覧ください」に置換される（リンクテキストを保持）
3. **Given** テキスト「https://github.com/user/repo から取得できます」, **When** TTS前処理を実行, **Then** 「ウェブサイト から取得できます」に置換される

---

### User Story 2 - 番号表記の自然な読み上げ (Priority: P2)

ユーザーが「No.X」形式の番号表記を含むテキストを聞く際、「ナンバーX」として自然に読み上げられる。

**Why this priority**: 「No.」は技術文書で頻出し、そのままでは「エヌオー」と読まれて不自然。

**Independent Test**: 「No.X」形式を含むテキストをTTS処理し、「ナンバー」+数字読みとして出力されることを確認。

**Acceptance Scenarios**:

1. **Given** テキスト「詳細は No.21 で説明します」, **When** TTS前処理を実行, **Then** 「詳細は ナンバーにじゅういち で説明します」に置換される
2. **Given** テキスト「製品No.123を確認」, **When** TTS前処理を実行, **Then** 「製品ナンバーひゃくにじゅうさんを確認」に置換される
3. **Given** テキスト「Chapter 5 を参照」, **When** TTS前処理を実行, **Then** 「だいごしょう を参照」に置換される

---

### User Story 3 - ISBN・書籍メタ情報の適切な処理 (Priority: P3)

ユーザーが書籍情報を含むテキストを聞く際、ISBN等のメタ情報が適切に処理され、不要な数字の羅列が読み上げられない。

**Why this priority**: ISBNは書籍メタ情報であり、音声で聞く必要性は低い。

**Independent Test**: ISBN形式の文字列を含むテキストをTTS処理し、ISBN部分が削除されていることを確認。

**Acceptance Scenarios**:

1. **Given** テキスト「ISBN978-4-7981-8771-6」, **When** TTS前処理を実行, **Then** 空文字に置換される
2. **Given** テキスト「この本（ISBN: 978-4-7981-8771-6）は良書です」, **When** TTS前処理を実行, **Then** 「この本は良書です」に置換される（括弧ごと削除）
3. **Given** テキスト「ISBN-10: 4-7981-8771-X」, **When** TTS前処理を実行, **Then** 空文字に置換される

---

### Edge Cases

- 文中の複数URLが連続する場合、各URLが個別に置換される
- URL直後に句読点がある場合、句読点は保持される
- 「No.」の後に数字がない場合（「No. を参照」）、置換しない
- ISBNが文頭にある場合、後続テキストの先頭空白は正規化される
- 「NO.」「no.」など大文字小文字の混在も「ナンバー」に置換される

## Requirements

### Functional Requirements

- **FR-001**: システムは裸のURL（`www.`や`http(s)://`で始まる文字列）を「ウェブサイト」に置換しなければならない
- **FR-002**: システムはMarkdownリンク`[テキスト](URL)`からURLを除去し、テキスト部分のみを保持しなければならない
- **FR-003**: システムはリンクテキスト自体がURLの場合（`[https://...](https://...)`）、「ウェブサイト」に置換しなければならない
- **FR-004**: システムは`No.X`形式（大文字小文字不問）を「ナンバーX」に変換しなければならない（Xは数字）
- **FR-005**: システムは`Chapter X`形式を「だいXしょう」に変換しなければならない
- **FR-006**: システムはISBN（10桁・13桁、ハイフン有無両対応）を削除しなければならない
- **FR-007**: システムはISBN削除後の不要な括弧・ラベル（「ISBN:」など）も削除しなければならない
- **FR-008**: システムは置換・削除後のテキストで不自然な空白が生じないよう正規化しなければならない
- **FR-009**: 既存の`text_cleaner.py`のパターン処理フローに統合し、処理順序を維持しなければならない

### Key Entities

- **TTS前処理パターン**: 置換または削除対象となる文字列パターン（URL、ISBN、番号表記など）
- **置換ルール**: パターンと置換先テキストの対応（正規表現ベース）
- **処理コンテキスト**: パターンの前後文脈（括弧、空白、句読点など）

## Success Criteria

### Measurable Outcomes

- **SC-001**: TTS出力に「ダブリュー」「ドット」「コム」「エイチティーティーピー」などのURL構成要素が含まれない
- **SC-002**: `No.X`形式が100%「ナンバーX」形式で読み上げられる
- **SC-003**: ISBN形式文字列がTTS出力に一切含まれない
- **SC-004**: 置換・削除後のテキストで二重空白や不自然な句読点配置が発生しない
- **SC-005**: 既存のテストケースがすべて通過する（回帰なし）

## 技術的考慮事項

### 処理順序の重要性

現在の`clean_page_text()`では以下の順序で処理される:
1. `_clean_urls()` - URL削除
2. `_clean_isbn()` - ISBN削除
3. `_clean_parenthetical_english()` - 括弧英語削除
4. `_normalize_references()` - 参照正規化

「No.」→「ナンバー」変換は既存の数値正規化（`normalize_numbers()`）の前に実行する必要がある。

### 既存コードとの統合

- `src/text_cleaner.py` の既存関数を拡張または新規関数を追加
- パターン定数は既存の定数群に追加

## Assumptions

- URL置換後の「ウェブサイト」は文脈上十分に明確（元のURLドメインは不要）
- ISBN削除は常に適切（書籍購入リンク等のユースケースは対象外）
- 「No.」は文脈に関係なく「ナンバー」に統一置換する

## 関連Issue

- #10 (辞書登録からの除外 - 完了)
- #12 (関連PR)
