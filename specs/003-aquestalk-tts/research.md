# AquesTalk 記法調査レポート

**作成日**: 2026-02-08
**目的**: XML 記法と AquesTalk 記法の比較、移行可能な機能の特定

## 1. 現在の XML 記法

### 1.1 構造要素

| 要素 | 説明 | 例 |
|------|------|-----|
| `<page>` | ページ単位 | `<page number="1" sourceFile="page_001.png">` |
| `<pageAnnouncement>` | ページ読み上げ | `<pageAnnouncement>1ページ</pageAnnouncement>` |
| `<content>` | コンテンツコンテナ | - |
| `<paragraph>` | 段落 | `<paragraph>本文テキスト</paragraph>` |
| `<heading>` | 見出し | `<heading level="1">章タイトル</heading>` |
| `<list>` / `<item>` | リスト | - |
| `<figure>` | 図 | `<figure readAloud="optional">` |

### 1.2 制御属性

| 属性 | 説明 | 値 |
|------|------|-----|
| `readAloud` | 読み上げ制御 | `"true"` / `"false"` / `"optional"` |
| `level` | 見出しレベル | `"1"` ~ `"6"` |

### 1.3 現在の処理フロー

```
XML → xml_parser → text_cleaner → VOICEVOX/AquesTalk
```

- `xml_parser`: XML を解析し、`readAloud="false"` の要素をスキップ
- `text_cleaner`: テキストをクリーニング（数字→カナ、略語→読み、漢字→カナ）
- HEADING_MARKER: 見出しの前に効果音挿入用マーカーを付与

## 2. AquesTalk 音声記号列仕様

### 2.1 読み記号

| 記法 | 説明 | 例 |
|------|------|-----|
| ひらがな | 無声化・鼻濁音化が自動適用 | `こんにちは` |
| カタカナ | 無声化・鼻濁音化なし | `コンニチハ` |

### 2.2 アクセント記号

| 記号 | 説明 | 例 |
|------|------|-----|
| `'` | アクセント核の位置 | `あ'め`（雨）vs `ア'メ`（飴） |

アクセント核の直後に配置。音の高さが「高→低」に変化する位置を示す。

### 2.3 句切記号

| 記号 | 説明 | ポーズ |
|------|------|--------|
| `/` | 句切り | なし |
| `;` | 句切り | なし |
| `+` | 句切り | なし |
| `。` | 句点 | あり |
| `、` | 読点 | あり |
| `？` | 疑問符 | あり |

### 2.4 特殊タグ

| タグ | 説明 | 例 |
|------|------|-----|
| `<NUM VAL=数値>` | 数値読み | `<NUM VAL=123>` → 「ひゃくにじゅうさん」 |
| `<ALPHA VAL=英数>` | 英数読み | `<ALPHA VAL=API>` → 「エーピーアイ」 |

### 2.5 制約事項

- 文字コード: Shift-JIS / UTF-8 / UTF-16（ライブラリ依存）
- Tab・改行コード等は使用不可
- NULL で終端

## 3. 機能比較と移行可能性

### 3.1 比較マトリクス

| 機能 | XML 記法 | AquesTalk 記法 | 対応方針 |
|------|----------|----------------|----------|
| 読み上げスキップ | `readAloud="false"` | なし（テキスト除外で対応） | ✅ 対応済み |
| 見出し強調 | `<heading>` + HEADING_MARKER | 句切記号 `/` で区切り可能 | ✅ 効果音 + 速度低下（speed 80）で対応 |
| アクセント制御 | なし | `'` 記号 | ❌ スコープ外 |
| ポーズ挿入 | なし | `。` `、` 等 | ✅ 見出し・段落末に自動追加 |
| 数値読み | text_cleaner で変換 | `<NUM>` タグ | ✅ `<NUM>` タグを採用 |
| 英数読み | reading_dict で変換 | `<ALPHA>` タグ | ✅ 既存辞書で対応 |

### 3.2 移行パターン

#### パターン A: 最小移行（推奨）

既存の text_cleaner をそのまま使用。AquesTalk 固有記法は使用しない。

```
XML → xml_parser → text_cleaner（カタカナ変換）→ AquesTalk
```

**メリット**:
- 実装コスト最小
- VOICEVOX 版と一貫した動作
- text_cleaner の読み辞書を活用

**デメリット**:
- AquesTalk のアクセント制御を活用できない

#### パターン B: 数値タグ活用

text_cleaner の数値変換を AquesTalk の `<NUM>` タグに置換。

```
"123" → "<NUM VAL=123>" （AquesTalk が読みを生成）
```

**メリット**:
- AquesTalk ネイティブの数値読み
- 桁区切りの自然な読み

**デメリット**:
- text_cleaner との二重処理回避が必要

#### パターン C: フルアクセント対応

XML に新しい属性を追加し、AquesTalk 記法を埋め込み可能にする。

```xml
<paragraph accent="あ'くせんと">アクセント</paragraph>
```

**メリット**:
- AquesTalk の機能をフル活用
- 高品質な音声生成

**デメリット**:
- XML スキーマ変更が必要
- 既存 XML との互換性問題
- スコープ外として定義済み

## 4. 決定事項

### 4.1 本フィーチャーでの対応範囲

**パターン B（数値タグ活用）を採用**

決定理由：
1. readAloud 属性による読み上げスキップは既存の仕組みで対応
2. 数値読みは AquesTalk の `<NUM>` タグを活用し、より自然な読み上げを実現
3. AquesTalk 固有のアクセント記法は Out of Scope を維持

### 4.2 追加決定事項

#### 見出し・段落末のポーズ処理

**問題**: 見出しや段落が「。」で終わっていない場合、次のテキストと連続して読まれてしまい聞きづらい。

**解決策**: 見出し末・段落末に句点がない場合、自動で `。` を追加。

**実装ルール**:
- 見出し末に句点がなければ `。` を追加
- 段落末に句点（`。` `！` `？`）がなければ `。` を追加
- 既に句点がある場合は追加しない（「。。」回避）

#### サンプルレート

**決定**: 16000Hz（AquesTalk10 標準）

- 効果音は 16000Hz にリサンプリングして統一
- VOICEVOX（24000Hz）とは異なるため、共通処理ではなく AquesTalk 専用の処理が必要
- AquesTalk pico (8000Hz) より高品質

#### 見出しの強調

**問題**: AquesTalk には直接的な「強調」や「音量」の制御機能がない。

**調査結果**:
- 速度 (speed): 50-300（デフォルト100）
- 声質 (voice): 0-200（デフォルト100）
- ピッチ (pitch): 50-200（デフォルト100）

**決定**: 見出しをゆっくり読む（speed 80）で強調感を出す

- 効果音 + 速度低下の組み合わせで「ここは見出し」という印象を与える
- emphasis タグも同様に対応可能（将来検討）

#### AquesTalk バージョン選択

**決定**: AquesTalk10 を使用

| バージョン | パラメータ | 採用 |
|-----------|-----------|------|
| AquesTalk pico | speed のみ | ❌ |
| AquesTalk10 | speed, voice, pitch | ✅ 採用 |

理由:
- 全パラメータに対応し、音声のカスタマイズ性が高い
- 出力サンプルレートは 16000Hz（pico の 8000Hz より高品質）
- 別途導入が必要だが、音声品質を優先

### 4.3 将来の拡張オプション

以下は別フィーチャーとして検討：

1. **アクセント辞書**: 単語ごとのアクセントパターンを辞書化
2. **XML 拡張**: `accent` 属性を追加して AquesTalk 記法を埋め込み
3. **自動アクセント推定**: MeCab のアクセント情報を活用

## 5. 参考資料

- [AquesTalk 音声記号列仕様書 v2.0](https://www.a-quest.com/archive/manual/siyo_onseikigou.pdf)
- [AquesTalk 公式サイト](https://www.a-quest.com/products/aquestalk.html)
- [ローマ字音声記号列仕様書](https://www.a-quest.com/archive/manual/roman_onseikigou.pdf)

## 6. 結論

現在の XML 記法から AquesTalk への移行において、以下の対応を実施：

| 機能 | 対応方法 |
|------|----------|
| 読み上げスキップ | xml_parser の readAloud 属性処理 |
| 見出し効果音 | HEADING_MARKER + 効果音挿入（8000Hz リサンプリング） |
| 見出し強調 | 速度低下（speed 80）でゆっくり読み上げ |
| 数値読み | AquesTalk の `<NUM>` タグを使用 |
| 英数読み | reading_dict の apply_reading_rules |
| 漢字読み | mecab_reader の convert_to_kana |
| ポーズ挿入 | 見出し末・段落末に自動で `。` 追加（連続回避） |

AquesTalk 固有のアクセント制御機能は、本フィーチャーではスコープ外とし、将来の拡張として検討する。
