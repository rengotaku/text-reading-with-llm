# Feature Specification: テスト実行戦略の改善

**Feature Branch**: `015-test-execution-strategy`
**Created**: 2026-03-01
**Status**: Draft
**Input**: GitHub Issue #27 - perf: テスト実行戦略の改善（タイムアウト対策）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 変更ファイルに関連するテストのみ実行 (Priority: P1)

開発者として、コード変更時に関連するテストのみを実行したい。これにより、フィードバックループを短縮し、タイムアウトを防止できる。

**Why this priority**: 現在509件のフルテスト実行が原因でタイムアウトが頻発している。変更に関連するテストのみ実行することで、実行時間を大幅に削減できる。

**Independent Test**: `make test-changed` コマンドを実行し、変更ファイルに関連するテストのみが実行されることを確認。フルテストより短時間で完了する。

**Acceptance Scenarios**:

1. **Given** Pythonファイルを変更した状態, **When** `make test-changed` を実行, **Then** 変更ファイルに関連するテストのみが実行される
2. **Given** テストファイルを変更した状態, **When** `make test-changed` を実行, **Then** 変更されたテストファイルが実行される
3. **Given** 変更がない状態, **When** `make test-changed` を実行, **Then** テストは実行されず、メッセージが表示される

---

### User Story 2 - 軽量テストの分離実行 (Priority: P2)

開発者として、クイックフィードバック用の軽量テストセットを実行したい。これにより、基本的な動作確認を迅速に行える。

**Why this priority**: 変更検出が困難な場合や、基本動作の確認が必要な場合のフォールバックとして有用。

**Independent Test**: `make test-quick` コマンドを実行し、マーカー付きの軽量テストのみが実行されることを確認。

**Acceptance Scenarios**:

1. **Given** 軽量テストにマーカーが付与されている状態, **When** `make test-quick` を実行, **Then** マーカー付きテストのみが実行される
2. **Given** 軽量テストが存在しない状態, **When** `make test-quick` を実行, **Then** 適切なエラーメッセージが表示される

---

### User Story 3 - CI でのフルテスト実行 (Priority: P3)

チームとして、PR マージ前に CI で全テストを実行し、品質を担保したい。ローカルでは軽量検証のみ行う。

**Why this priority**: ローカルでのタイムアウト回避とコード品質の両立を実現。

**Independent Test**: PR 作成時に GitHub Actions でフルテストが実行されることを確認。

**Acceptance Scenarios**:

1. **Given** PR が作成された状態, **When** CI ワークフローが起動, **Then** 全テスト（509件）が実行される
2. **Given** CI テストが失敗した状態, **When** PR をマージしようとする, **Then** マージがブロックされる

---

### Edge Cases

- 変更ファイルに関連するテストが存在しない場合、どうするか？ → 警告メッセージを表示し、テストはスキップ
- 変更ファイルの検出に失敗した場合、どうするか？ → フォールバックとして軽量テストを実行
- テストファイル自体のみが変更された場合、どうするか？ → そのテストファイルのみを実行

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、変更されたファイルを検出し、関連するテストを特定できなければならない
- **FR-002**: システムは、`make test-changed` コマンドで変更関連テストのみを実行できなければならない
- **FR-003**: システムは、`make test-quick` コマンドで軽量テストのみを実行できなければならない
- **FR-004**: システムは、pytest マーカー（例: `@pytest.mark.quick`）で軽量テストを識別できなければならない
- **FR-005**: CI ワークフローは、PR 作成時にフルテストスイートを実行しなければならない
- **FR-006**: 既存の `make test` コマンドは、フルテスト実行として引き続き利用可能でなければならない

### Key Entities

- **変更ファイル**: Git で検出される変更済みファイル（staged/unstaged）
- **関連テスト**: 変更ファイルをインポートまたは参照するテストファイル
- **軽量テスト**: `@pytest.mark.quick` マーカーが付与された高速実行可能なテスト
- **Makefile ターゲット**: テスト実行戦略を抽象化するコマンドインターフェース

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ローカルでのテスト実行時間が、変更関連テストのみの場合、フルテスト時間の20%以下に短縮される
- **SC-002**: Speckit セッションでのテストタイムアウト発生率が60%以上削減される
- **SC-003**: 開発者は、コード変更後30秒以内にテストフィードバックを得られる
- **SC-004**: CI でのフルテスト実行により、リグレッションの検出漏れがゼロに維持される

## Clarifications

### Session 2026-03-01

- Q: テストが遅い原因はモック不使用か？ → A: モックは660箇所で適切に使用されている。問題は `test_xml2_pipeline.py` (79テスト/2380行) がフルスイート実行時にハングする点。個別テストは高速（< 1秒）だが、連続実行で問題が発生。

## Root Cause Analysis

調査結果:
- **モック使用率**: 660箇所 - テストは適切にモック化されている
- **個別テスト実行**: 各テスト < 1秒で高速
- **フルスイート実行**: 5分以上でタイムアウト（84%完了時点で停止）
- **問題テストファイル**: `test_xml2_pipeline.py` - pytest の連続実行時にハング
- **pytest-timeout**: 効果なし（テストが正常に kill されない）

原因の可能性:
1. テスト間の状態分離の問題（グローバル状態、シングルトン、リソースリーク）
2. プロセスフォーク/マルチスレッドの競合
3. ファイルシステムやネットワークリソースの競合

## Assumptions

- Git リポジトリで作業していることを前提とする
- pytest を使用したテストフレームワークが導入済み
- Makefile がビルド・テストタスクの標準インターフェースとして使用されている
- GitHub Actions が CI プラットフォームとして使用されている
- テストの個別実行は高速であり、モック化は適切に行われている
