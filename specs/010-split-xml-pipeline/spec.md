# 機能仕様: XML パイプライン分割

**フィーチャーブランチ**: `010-split-xml-pipeline`
**作成日**: 2026-02-23
**ステータス**: Draft
**入力**: GitHub Issue #14 - xml2_pipeline を分割し、Makefile から各ステップを個別実行可能にする

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - テキストクリーニング単独実行 (優先度: P1)

開発者として、XML ファイルからクリーニング済みテキストのみを生成したい。TTS 処理を待たずにテキスト内容を確認・デバッグできるようにするため。

**この優先度の理由**: パイプライン分割の核心機能。TTS は時間がかかるため、テキストクリーニングのみを実行できることが最も価値が高い。

**独立テスト**: `make clean-text INPUT=sample.xml` を実行し、`cleaned_text.txt` が正しく生成されることを確認。TTS 処理は不要。

**受け入れシナリオ**:

1. **Given** XML ファイルが存在する, **When** `make clean-text INPUT=sample.xml` を実行, **Then** 出力ディレクトリに `cleaned_text.txt` が生成される
2. **Given** `cleaned_text.txt` が既に存在する, **When** `make clean-text` を再実行, **Then** 既存ファイルが上書きされる
3. **Given** XML ファイルが存在しない, **When** `make clean-text INPUT=nonexistent.xml` を実行, **Then** エラーメッセージが表示され終了コード 1 が返る

---

### ユーザーストーリー 2 - 既存テキストから TTS 生成 (優先度: P2)

開発者として、事前に生成した `cleaned_text.txt` から TTS 音声のみを生成したい。テキストを再度クリーニングせずに音声生成をやり直せるようにするため。

**この優先度の理由**: TTS パラメータ（速度、スタイル等）の調整時にテキストクリーニングをスキップできることで時間を節約できる。

**独立テスト**: 既存の `cleaned_text.txt` を使用して `make xml-tts` を実行し、音声ファイルが生成されることを確認。

**受け入れシナリオ**:

1. **Given** `cleaned_text.txt` が存在する, **When** `make xml-tts` を実行, **Then** 音声ファイルが生成される
2. **Given** `cleaned_text.txt` が存在しない, **When** `make xml-tts` を実行, **Then** 適切なエラーメッセージが表示される
3. **Given** TTS パラメータを変更, **When** `make xml-tts SPEED=1.5` を実行, **Then** 新しいパラメータで音声が生成される

---

### ユーザーストーリー 3 - 全ステップ一括実行 (優先度: P3)

開発者として、すべてのステップを順次実行する単一コマンドを使いたい。既存のワークフローを維持しつつ、必要時には個別実行もできるようにするため。

**この優先度の理由**: 後方互換性の維持。既存ユーザーのワークフローを壊さない。

**独立テスト**: `make run INPUT=sample.xml` を実行し、辞書生成 → テキストクリーニング → TTS 生成がすべて完了することを確認。

**受け入れシナリオ**:

1. **Given** XML ファイルが存在する, **When** `make run INPUT=sample.xml` を実行, **Then** 辞書生成、テキストクリーニング、TTS 生成が順次実行される
2. **Given** 途中のステップでエラー発生, **When** `make run` 実行中にエラー, **Then** 後続ステップは実行されず適切なエラーが表示される

---

### エッジケース

- 出力ディレクトリが存在しない場合、自動的に作成される
- 入力ファイルのパスに空白が含まれる場合も正しく処理される
- 辞書ファイルが存在しない状態でテキストクリーニングを実行した場合の動作
- 大容量 XML ファイル（数百 MB）を処理する場合のメモリ使用量

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは `make clean-text` コマンドでテキストクリーニングのみを実行できなければならない
- **FR-002**: システムは `make xml-tts` コマンドで既存の `cleaned_text.txt` から TTS 音声を生成できなければならない
- **FR-003**: システムは `make run` コマンドで辞書生成 → テキストクリーニング → TTS 生成を順次実行できなければならない
- **FR-004**: 各 Makefile ターゲットは独立して実行可能でなければならない
- **FR-005**: 既存の `make gen-dict` と `make xml-tts` コマンドは後方互換性を維持しなければならない
- **FR-006**: エラー発生時は明確なエラーメッセージを表示し、適切な終了コードを返さなければならない

### 主要エンティティ

- **ContentItem**: XML から抽出されたコンテンツ単位（テキスト、章番号、見出し情報を含む）
- **CleanedText**: クリーニング済みテキスト（URL 除去、英語括弧除去、数字変換等が適用済み）
- **読み辞書**: 固有名詞や専門用語の読み方を定義したファイル

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 開発者は TTS 処理なしでテキストクリーニング結果を 10 秒以内に確認できる
- **SC-002**: TTS パラメータ調整時、テキストクリーニングをスキップすることで処理時間を 50% 以上短縮できる
- **SC-003**: 既存の一括実行ワークフロー（`make run`）は変更なく動作する
- **SC-004**: すべての Makefile ターゲットは help コマンドで説明が表示される

## 前提条件

- XML パーサー（`xml2_parser.py`）は既に独立したモジュールとして存在
- テキストクリーニング機能（`text_cleaner.py`）は既に独立したモジュールとして存在
- 読み辞書生成（`generate_reading_dict.py`）は既に独立したスクリプトとして存在
- VOICEVOX 関連の設定は既存のまま維持

## スコープ外

- XML パーサー自体の変更
- テキストクリーニングロジックの変更
- 読み辞書生成ロジックの変更
- VOICEVOX 設定や音声品質の変更
- GUI やウェブインターフェースの追加
